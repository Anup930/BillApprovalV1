<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Final Approval Dashboard</title>
    <style>
        /* --- Styles --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; color: #333; display: flex; height: 100vh; }
        .sidebar { width: 200px; background-color: #2c3e50; color: white; padding-top: 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .main-content { flex-grow: 1; padding: 20px 40px; overflow-y: auto; }
        .sidebar-header { padding: 0 20px 20px 20px; font-size: 1.2em; font-weight: bold; border-bottom: 1px solid #34495e; }
        .sidebar-nav { flex-grow: 1; }
        .sidebar-nav a, .sidebar-nav button, .logout-btn { display: block; width: 100%; padding: 15px 20px; background: none; border: none; color: #bdc3c7; text-align: left; font-size: 1em; cursor: pointer; border-bottom: 1px solid #34495e; text-decoration: none; box-sizing: border-box; }
        .sidebar-nav a:hover, .sidebar-nav button:hover, .logout-btn:hover { background-color: #34495e; color: #ffffff; }
        .sidebar-nav a.active, .sidebar-nav button.active { background-color: #4267B2; color: #ffffff; font-weight: bold; }
        .logout-btn { border-top: 1px solid #34495e; border-bottom: none; }
        .content-section { display: none; }
        .content-section.visible { display: block; }
        .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        h1, h2 { color: #1c1e21; padding-bottom: 10px; margin-bottom: 0; border: none; }
        table { border-collapse: collapse; width: 100%; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        thead { background-color: #17a2b8; color: white; }
        th, td { text-align: left; padding: 12px 15px; border-bottom: 1px solid #ddd; }
        tbody tr { cursor: pointer; transition: background-color 0.2s; }
        tbody tr:hover { background-color: #e9ebee; }
        .approve-btn, .reject-btn { padding: 8px 15px; margin: 0 5px 0 0; font-size: 14px; border-radius: 6px; border: none; cursor: pointer; color: white; }
        .approve-btn { background-color: #42b72a; } .approve-btn:hover { background-color: #36a420; }
        .reject-btn { background-color: #fa3e3e; } .reject-btn:hover { background-color: #e03838; }
        .pdf-link { color: #4267B2; text-decoration: none; font-weight: bold; }
        .column-selector { position: relative; }
        .column-selector-btn { background-color: #f0f2f5; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .column-dropdown { display: none; position: absolute; right: 0; top: 30px; background-color: white; border: 1px solid #ccc; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 4px; padding: 10px; z-index: 100; max-height: 400px; overflow-y: auto;}
        .column-dropdown.visible { display: block; }
        .column-dropdown div { padding: 5px; white-space: nowrap; }
        .column-dropdown label { margin-left: 5px; cursor: pointer; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 20px 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; position: relative; }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 2.5em; line-height: 1; cursor: pointer; color: #888; }
        .modal-body { display: grid; grid-template-columns: auto 1fr; gap: 12px 20px; margin-top: 15px; }
        .modal-body .key { font-weight: bold; color: #555; text-align: right; }
        .modal-body .value { word-break: break-all; }
        .modal-body .value a { color: #007bff; text-decoration: none; }
        .modal-body .value a:hover { text-decoration: underline; }
        #rejection-modal .modal-content { max-width: 500px; }
        #rejection-modal textarea { width: 100%; min-height: 80px; margin-top: 10px; padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 1em; }
        .loader { text-align: center; font-weight: bold; padding: 20px; }
        #rejection-modal .modal-actions { margin-top: 20px; text-align: right; }
        #rejection-modal button { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; }
        #rejection-modal #rejection-cancel-btn { background-color: #ccc; margin-right: 10px; }
        #rejection-modal #rejection-submit-btn { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">Final Approval View</div>
        <!-- === MODIFIED: New Sidebar Navigation === -->
        <div class="sidebar-nav">
            <a id="nav-dashboard" href="final_dashboard.html">Dashboard</a>
            <a id="nav-queues" href="final.html" class="active">Approval Queues</a>
            <button id="nav-pending" onclick="showSection('pending')">&nbsp;&nbsp;&nbsp;My Pending</button>
            <button id="nav-approved" onclick="showSection('approved')">&nbsp;&nbsp;&nbsp;My Approved</button>
            <button id="nav-rejected" onclick="showSection('rejected')">&nbsp;&nbsp;&nbsp;My Rejected</button>
            <button id="nav-hod-pending" onclick="showSection('hod-pending')">&nbsp;&nbsp;&nbsp;From HOD</button>
        </div>
        <button class="logout-btn" onclick="logoutUser()">Logout</button>
    </div>

    <div class="main-content">
        <h1 id="welcome-message">Final Approval Queues</h1>
        <div id="pending-section" class="content-section"><div class="section-header"><h2>My Pending Approvals</h2><div class="column-selector" id="pending-selector"></div></div><div id="pending-loader" class="loader">Loading...</div><table id="pending-table" style="display:none;"><thead></thead><tbody></tbody></table><p id="no-pending" style="display:none;">You have no pending approvals.</p></div>
        <div id="approved-section" class="content-section"><div class="section-header"><h2>My Approved Items</h2><div class="column-selector" id="approved-selector"></div></div><div id="approved-loader" class="loader">Loading...</div><table id="approved-table" style="display:none;"><thead></thead><tbody></tbody></table><p id="no-approved" style="display:none;">No approved items found.</p></div>
        <div id="rejected-section" class="content-section"><div class="section-header"><h2>My Rejected Items</h2><div class="column-selector" id="rejected-selector"></div></div><div id="rejected-loader" class="loader">Loading...</div><table id="rejected-table" style="display:none;"><thead></thead><tbody></tbody></table><p id="no-rejected" style="display:none;">No rejected items found.</p></div>
        <div id="hod-pending-section" class="content-section">
            <div class="section-header"><h2>Pending From HOD</h2><div class="column-selector" id="hod-pending-selector"></div></div>
            <div id="hod-pending-loader" class="loader">Loading...</div><table id="hod-pending-table" style="display:none;"><thead></thead><tbody></tbody></table>
            <p id="no-hod-pending" style="display:none;">No items are currently pending with HODs.</p>
        </div>
    </div>
    
    <div id="details-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close-btn" onclick="closeModal('details-modal')">&times;</button><h2>Full Details</h2><div id="modal-body" class="modal-body"></div></div></div>
    <div id="rejection-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close-btn" onclick="closeModal('rejection-modal')">&times;</button><h2>Reason for Rejection</h2><p>Please provide a reason for rejecting this item.</p><textarea id="rejection-reason-text"></textarea><div class="modal-actions"><button id="rejection-cancel-btn" onclick="closeModal('rejection-modal')">Cancel</button><button id="rejection-submit-btn">Submit Rejection</button></div></div></div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrwUdXo0iEj4IMh3OKEjj8o4lVjvUkrq2GG_we3tLJcwGT4LgA2FoHKd6BLZW3Rqxc/exec";

        let loadedData = {};
        let availableColumns = {};
        const DEFAULT_VISIBLE_COLS = ['uniqueID', 'vendor', 'invoiceNumber', 'finalAmountPayable', 'pDFLink', 'hODApproval'];

        async function callAppsScript(functionName, params = []) {
            /* ... Unchanged ... */
            const response = await fetch(SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: functionName, params: params }) });
            const result = await response.json();
            if (!result.success) throw new Error(result.message);
            return result.data;
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const currentUser = localStorage.getItem('approvalName');
            const userType = localStorage.getItem('approvalType');

            if (!currentUser || userType !== 'Final') { window.location.href = 'index.html'; return; }

            document.getElementById('welcome-message').textContent += ` (Welcome, ${currentUser})`;
            document.querySelectorAll('.modal-overlay').forEach(modal => { modal.onclick = (event) => { if (event.target === modal) closeModal(modal.id); }; });
            window.addEventListener('click', () => { document.querySelectorAll('.column-dropdown').forEach(d => d.classList.remove('visible')); });

            try {
                const [userData, hodData] = await Promise.all([
                    callAppsScript('getUserData', [currentUser, 'Final']),
                    callAppsScript('getHodPendingData')
                ]);

                loadedData = { pending: userData.pending, approved: userData.approved, rejected: userData.rejected, 'hod-pending': hodData };
                availableColumns = userData.columnMap;
                
                initializeColumnSelectors();
                renderTable('pending', loadedData.pending);
                renderTable('approved', loadedData.approved);
                renderTable('rejected', loadedData.rejected);
                renderTable('hod-pending', loadedData['hod-pending']);
                
                // --- MODIFIED: Check for URL parameter ---
                const urlParams = new URLSearchParams(window.location.search);
                const sectionToShow = urlParams.get('section');
                if (sectionToShow && document.getElementById(sectionToShow + '-section')) {
                    showSection(sectionToShow);
                } else {
                    showSection('pending');
                }

            } catch (error) {
                alert('Failed to load data: ' + error.message);
            }
        });
        
        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('visible'));
            document.querySelectorAll('.sidebar-nav button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(sectionName + '-section').classList.add('visible');
            const navButton = document.getElementById('nav-' + sectionName);
            if (navButton) navButton.classList.add('active');
            // Ensure main 'Queues' link is also active
            document.getElementById('nav-queues').classList.add('active');
        }

        // --- All other JavaScript functions are unchanged ---
        function logoutUser() { localStorage.clear(); window.location.href = 'index.html'; }
        async function showDetails(uniqueId) { /* ... */ 
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = '<div class="loader">Loading...</div>';
            openModal('details-modal');
            try {
                const details = await callAppsScript('getEntryDetails', [uniqueId]);
                if (!details) { modalBody.innerHTML = 'Error: Entry not found.'; return; }
                let contentHtml = '';
                for (const key in details) { if (details[key] !== '') { let value = details[key]; if (typeof value === 'string' && value.startsWith('http')) { value = `<a href="${value}" target="_blank">${value}</a>`; } contentHtml += `<div class="key">${key}:</div><div class="value">${value}</div>`; } }
                modalBody.innerHTML = contentHtml;
            } catch (error) { modalBody.innerHTML = `Error: ${error.message}`; }
        }
        function handleHodPendingAction(uniqueId, isApproved, btnElement) { /* ... */
            event.stopPropagation();
            if (isApproved) { submitHodAndFinalUpdate(uniqueId, 'Approved', btnElement); } else {
                openModal('rejection-modal');
                const reasonText = document.getElementById('rejection-reason-text');
                const submitBtn = document.getElementById('rejection-submit-btn');
                reasonText.value = '';
                submitBtn.onclick = () => { const reason = reasonText.value.trim(); if (!reason) { alert("A reason is required to reject an item."); return; } submitHodAndFinalUpdate(uniqueId, `Rejected: ${reason}`, btnElement); };
            }
        }
        async function submitHodAndFinalUpdate(uniqueId, newStatus, btnElement) { /* ... */
            closeModal('rejection-modal');
            const actionCell = btnElement.parentElement;
            actionCell.innerHTML = 'Submitting...';
            try { await callAppsScript('updateHodAndFinalStatus', [uniqueId, newStatus]); window.location.reload(); } catch (error) { alert("Submission failed: " + error.message); actionCell.innerHTML = `<button class="approve-btn" onclick="handleHodPendingAction('${uniqueId}', true, this)">Approve</button><button class="reject-btn" onclick="handleHodPendingAction('${uniqueId}', false, this)">Reject</button>`; }
        }
        function handleApproval(uniqueId, isApproved, btnElement) { /* ... */
            event.stopPropagation();
            if (isApproved) { submitUpdate(uniqueId, 'Approved', btnElement); } else {
                openModal('rejection-modal');
                const reasonText = document.getElementById('rejection-reason-text');
                const submitBtn = document.getElementById('rejection-submit-btn');
                reasonText.value = '';
                submitBtn.onclick = () => { const reason = reasonText.value.trim(); if (!reason) { alert("A reason is required to reject an item."); return; } submitUpdate(uniqueId, `Rejected: ${reason}`, btnElement); };
            }
        }
        async function submitUpdate(uniqueId, newStatus, btnElement) { /* ... */
            closeModal('rejection-modal');
            const actionCell = btnElement.parentElement;
            actionCell.innerHTML = 'Submitting...';
            try { await callAppsScript('updateApprovalStatus', [uniqueId, newStatus, 'Final']); window.location.reload(); } catch (error) { alert("Submission failed: " + error.message); actionCell.innerHTML = `<button class="approve-btn" onclick="handleApproval('${uniqueId}', true, this)">Approve</button><button class="reject-btn" onclick="handleApproval('${uniqueId}', false, this)">Reject</button>`; }
        }
        function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        function renderTable(tableType, data) { /* ... */
            const table = document.getElementById(`${tableType}-table`);
            const thead = table.querySelector("thead"); const tbody = table.querySelector("tbody");
            document.getElementById(`${tableType}-loader`).style.display = 'none';
            thead.innerHTML = ''; tbody.innerHTML = '';
            if (!data || data.length === 0) { document.getElementById(`no-${tableType}`).style.display = 'block'; table.style.display = 'none'; return; }
            table.style.display = 'table'; document.getElementById(`no-${tableType}`).style.display = 'none';
            const storageKey = `final-${tableType}-cols`; 
            let visibleCols = JSON.parse(localStorage.getItem(storageKey)) || DEFAULT_VISIBLE_COLS;
            const headerRow = document.createElement('tr');
            visibleCols.forEach(key => { if (availableColumns[key]) { const th = document.createElement('th'); th.textContent = availableColumns[key]; headerRow.appendChild(th); } });
            if (tableType === 'pending' || tableType === 'hod-pending') { headerRow.insertAdjacentHTML('beforeend', '<th>Action</th>'); } else if (!visibleCols.includes('status')) { headerRow.insertAdjacentHTML('beforeend', '<th>Status</th>'); }
            thead.appendChild(headerRow);
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.onclick = () => showDetails(row.uniqueID);
                visibleCols.forEach(key => { if (availableColumns[key]) { const td = document.createElement('td'); if (key === 'pDFLink' && row[key]) { td.innerHTML = `<a href="${row[key]}" target="_blank" class="pdf-link" onclick="event.stopPropagation()">View Bill</a>`; } else { td.textContent = row[key]; } tr.appendChild(td); } });
                if (tableType === 'pending') { tr.insertAdjacentHTML('beforeend', `<td onclick="event.stopPropagation()"><button class="approve-btn" onclick="handleApproval('${row.uniqueID}', true, this)">Approve</button><button class="reject-btn" onclick="handleApproval('${row.uniqueID}', false, this)">Reject</button></td>`); } else if (tableType === 'hod-pending') { tr.insertAdjacentHTML('beforeend', `<td onclick="event.stopPropagation()"><button class="approve-btn" onclick="handleHodPendingAction('${row.uniqueID}', true, this)">Approve</button><button class="reject-btn" onclick="handleHodPendingAction('${row.uniqueID}', false, this)">Reject</button></td>`); } else if (!visibleCols.includes('status')) { tr.insertAdjacentHTML('beforeend', `<td>${row.status || ''}</td>`); }
                tbody.appendChild(tr);
            });
        }
        function initializeColumnSelectors() { /* ... */
            ['pending', 'approved', 'rejected', 'hod-pending'].forEach(tableType => {
                const selectorContainer = document.getElementById(`${tableType}-selector`);
                if (!selectorContainer) return;
                const storageKey = `final-${tableType}-cols`;
                const btn = document.createElement('button'); btn.className = 'column-selector-btn'; btn.textContent = 'Select Columns';
                const dropdown = document.createElement('div'); dropdown.className = 'column-dropdown';
                let visibleCols = JSON.parse(localStorage.getItem(storageKey)) || DEFAULT_VISIBLE_COLS;
                Object.entries(availableColumns).forEach(([key, title]) => {
                    if (title.toLowerCase().includes('status') || title.toLowerCase().includes('approval')) return;
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `<input type="checkbox" id="${tableType}-${key}" value="${key}" ${visibleCols.includes(key) ? 'checked' : ''}><label for="${tableType}-${key}">${title}</label>`;
                    optionDiv.querySelector('input').addEventListener('change', () => { const newVisibleCols = Array.from(dropdown.querySelectorAll('input:checked')).map(cb => cb.value); localStorage.setItem(storageKey, JSON.stringify(newVisibleCols)); renderTable(tableType, loadedData[tableType]); });
                    dropdown.appendChild(optionDiv);
                });
                selectorContainer.innerHTML = ''; selectorContainer.appendChild(btn); selectorContainer.appendChild(dropdown);
                btn.addEventListener('click', (e) => { e.stopPropagation(); dropdown.classList.toggle('visible'); });
            });
        }
    </script>
</body>
</html>
