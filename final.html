<!-- V6.0.2 -->

<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <title>Final Approval Queues</title>
<!--     <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet"> -->
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #f0f2f5;
        margin: 0;
        color: #333;
        display: flex;
        height: 100vh;
      }
      .sidebar {
        width: 220px; /* Slightly wider sidebar */
        background-color: #2c3e50;
        color: white;
        padding-top: 20px;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      }
      .main-content {
        flex-grow: 1;
        padding: 20px 30px; /* Adjusted padding for main content */
        overflow-y: auto;
      }
      .sidebar-header {
        padding: 0 20px 20px 20px;
        font-size: 1.3em; /* Slightly larger header font */
        font-weight: bold;
        border-bottom: 1px solid #34495e;
      }
      .sidebar-nav {
        flex-grow: 1;
      }
      .sidebar-nav a,
      .sidebar-nav button,
      .logout-btn {
        display: block;
        width: 100%;
        padding: 15px 20px;
        background: none;
        border: none;
        color: #bdc3c7;
        text-align: left;
        font-size: 1em;
        cursor: pointer;
        border-bottom: 1px solid #34495e;
        text-decoration: none;
        box-sizing: border-box;
        transition: background-color 0.2s, color 0.2s;
      }
      .sidebar-nav a:hover,
      .sidebar-nav button:hover,
      .logout-btn:hover {
        background-color: #3f5873; /* Darker hover for sidebar */
        color: #ffffff;
      }
      .sidebar-nav a.active,
      .sidebar-nav button.active {
        background-color: #4267b2;
        color: #ffffff;
        font-weight: bold;
      }
      .logout-btn {
        border-top: 1px solid #34495e;
        border-bottom: none;
        margin-top: auto; /* Pushes logout to the bottom */
      }
      .content-section {
        display: none;
      }
      .content-section.visible {
        display: block;
      }
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        /* border-bottom: 1px solid #ddd; Removed bottom border here */
        margin-bottom: 20px;
        padding-bottom: 10px; /* Added padding for space */
        border-bottom: 1px solid #e0e0e0; /* Lighter border */
      }
      h1,
      h2 {
        color: #1c1e21;
        padding-bottom: 0; /* Adjusted */
        margin-bottom: 0;
        border: none;
        font-size: 1.8em; /* Consistent heading size */
        font-weight: 600;
      }
      h2 {
        font-size: 1.5em; /* Sub-heading size */
        font-weight: 500;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        background: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Stronger, softer shadow */
        border-radius: 8px;
        overflow: hidden;
      }
      thead {
        background-color: #17a2b8;
        color: white;
      }
      th,
      td {
        text-align: left;
        padding: 12px 15px;
        border-bottom: 1px solid #eee; /* Lighter border for rows */
      }
      tbody tr {
        cursor: pointer;
        transition: background-color 0.2s;
      }
      tbody tr:hover {
        background-color: #f5f7f9; /* Lighter hover color */
      }
      .approve-btn,
      .reject-btn {
        padding: 8px 15px;
        margin: 0 5px 0 0;
        font-size: 0.9em; /* Slightly smaller font for buttons */
        border-radius: 5px; /* Slightly less rounded */
        border: none;
        cursor: pointer;
        color: white;
        transition: background-color 0.2s, box-shadow 0.2s;
      }
      .approve-btn {
        background-color: #28a745; /* Green */
      }
      .approve-btn:hover {
        background-color: #218838;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
      }
      .reject-btn {
        background-color: #dc3545; /* Red */
      }
      .reject-btn:hover {
        background-color: #c82333;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
      }
      .pdf-link {
        color: #4267b2;
        text-decoration: none;
        font-weight: 500; /* Slightly less bold */
        transition: color 0.2s;
      }
      .pdf-link:hover {
        color: #2b4a8e;
        text-decoration: underline;
      }
      .column-selector {
        position: relative;
        display: inline-block; /* Ensure it wraps its content */
      }
      .column-selector-btn {
        background-color: #ffffff; /* White background */
        border: 1px solid #ced4da; /* Light grey border */
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        color: #333;
        transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .column-selector-btn:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
      }
      .column-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 40px; /* Adjusted to be below the button */
        background-color: white;
        border: 1px solid #ced4da;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15); /* Stronger shadow for dropdown */
        border-radius: 6px;
        padding: 10px;
        z-index: 100;
        max-height: 400px;
        overflow-y: auto;
        min-width: 180px; /* Ensure some minimum width */
      }
      .column-dropdown.visible {
        display: block;
      }
      .column-dropdown div {
        padding: 5px 0; /* Adjusted padding */
        white-space: nowrap;
        display: flex; /* For better alignment of checkbox and label */
        align-items: center;
      }
      .column-dropdown input[type="checkbox"] {
        margin-right: 8px; /* Space between checkbox and label */
      }
      .column-dropdown label {
        margin-left: 0; /* Removed default margin */
        cursor: pointer;
        flex-grow: 1; /* Allow label to take available space */
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7); /* Darker overlay */
        z-index: 1000;
        display: none;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: #fff;
        padding: 25px 35px; /* More padding */
        border-radius: 10px; /* More rounded corners */
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); /* Stronger, deeper shadow */
        width: 90%;
        max-width: 700px;
        max-height: 85vh;
        overflow-y: auto;
        position: relative;
        animation: fadeIn 0.3s ease-out; /* Simple animation */
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .modal-close-btn {
        position: absolute;
        top: 12px; /* Adjusted position */
        right: 18px; /* Adjusted position */
        background: none;
        border: none;
        font-size: 2.2em; /* Slightly smaller close button */
        line-height: 1;
        cursor: pointer;
        color: #888;
        transition: color 0.2s;
      }
      .modal-close-btn:hover {
        color: #333;
      }
      .modal-body {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 12px 20px;
        margin-top: 15px;
      }
      .modal-body .key {
        font-weight: 600; /* Slightly bolder */
        color: #555;
        text-align: right;
      }
      .modal-body .value {
        word-break: break-word; /* Changed to break-word for better handling of long URLs */
      }
      #rejection-modal .modal-content {
        max-width: 500px;
      }
      #rejection-modal textarea {
        width: calc(100% - 16px); /* Account for padding */
        min-height: 100px; /* Slightly taller textarea */
        margin-top: 15px; /* More space */
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 1em;
        resize: vertical; /* Allow vertical resizing */
      }
      .loader {
        text-align: center;
        font-weight: bold;
        padding: 20px;
        color: #555;
      }
      #rejection-modal .modal-actions {
        margin-top: 25px; /* More space */
        text-align: right;
      }
      #rejection-modal button {
        padding: 10px 20px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-size: 1em;
        transition: background-color 0.2s, box-shadow 0.2s;
      }
      #rejection-modal #rejection-cancel-btn {
        background-color: #6c757d; /* Darker grey */
        color: white;
        margin-right: 10px;
      }
      #rejection-modal #rejection-cancel-btn:hover {
        background-color: #5a6268;
        box-shadow: 0 2px 4px rgba(108, 117, 125, 0.2);
      }
      #rejection-modal #rejection-submit-btn {
        background-color: #dc3545;
        color: white;
      }
      #rejection-modal #rejection-submit-btn:hover {
        background-color: #c82333;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="sidebar-header">Final Approval View</div>
      <div class="sidebar-nav">
        <a id="nav-dashboard" href="final_dashboard.html">Dashboard</a>
        <a id="nav-queues" href="final.html" class="active">Approval Queues</a>
        <button id="nav-pending" onclick="showSection('pending')">
          &nbsp;&nbsp;&nbsp;My Pending
        </button>
        <button id="nav-approved" onclick="showSection('approved')">
          &nbsp;&nbsp;&nbsp;My Approved
        </button>
        <button id="nav-rejected" onclick="showSection('rejected')">
          &nbsp;&nbsp;&nbsp;My Rejected
        </button>
        <button id="nav-hod-pending" onclick="showSection('hod-pending')">
          &nbsp;&nbsp;&nbsp;From HOD
        </button>
        <button id="nav-pay" onclick="showSection('pay')">
          &nbsp;&nbsp;&nbsp;See Pay
        </button>
      </div>
      <button class="logout-btn" onclick="logoutUser()">Logout</button>
    </div>

    <div class="main-content">
      <h1 id="welcome-message">Final Approval Queues</h1>
      <div id="pending-section" class="content-section">
        <div class="section-header">
          <h2>My Pending Approvals</h2>
          <div class="column-selector" id="pending-selector"></div>
        </div>
        <div id="pending-loader" class="loader">Loading...</div>
        <table id="pending-table" style="display: none">
          <thead></thead>
          <tbody></tbody>
        </table>
        <p id="no-pending" style="display: none">
          You have no pending approvals.
        </p>
      </div>
      <div id="approved-section" class="content-section">
        <div class="section-header">
          <h2>My Approved Items</h2>
          <div class="column-selector" id="approved-selector"></div>
        </div>
        <div id="approved-loader" class="loader">Loading...</div>
        <table id="approved-table" style="display: none">
          <thead></thead>
          <tbody></tbody>
        </table>
        <p id="no-approved" style="display: none">No approved items found.</p>
      </div>
      <div id="rejected-section" class="content-section">
        <div class="section-header">
          <h2>My Rejected Items</h2>
          <div class="column-selector" id="rejected-selector"></div>
        </div>
        <div id="rejected-loader" class="loader">Loading...</div>
        <table id="rejected-table" style="display: none">
          <thead></thead>
          <tbody></tbody>
        </table>
        <p id="no-rejected" style="display: none">No rejected items found.</p>
      </div>
      <div id="hod-pending-section" class="content-section">
        <div class="section-header">
          <h2>Pending From HOD</h2>
          <div class="column-selector" id="hod-pending-selector"></div>
        </div>
        <div id="hod-pending-loader" class="loader">Loading...</div>
        <table id="hod-pending-table" style="display: none">
          <thead></thead>
          <tbody></tbody>
        </table>
        <p id="no-hod-pending" style="display: none">
          No items are currently pending with HODs.
        </p>
      </div>
      <div id="pay-section" class="content-section">
        <div class="section-header">
          <h2>Paid Bills</h2>
          <div class="column-selector" id="pay-selector"></div>
        </div>
        <div id="pay-loader" class="loader">Loading...</div>
        <table id="pay-table" style="display: none">
          <thead></thead>
          <tbody></tbody>
        </table>
        <p id="no-pay" style="display: none">
          No paid bills found.
        </p>
      </div>
    </div>

    <div id="details-modal" class="modal-overlay">
      <div class="modal-content">
        <button class="modal-close-btn" onclick="closeModal('details-modal')">
          &times;
        </button>
        <h2>Full Details</h2>
        <div id="modal-body" class="modal-body"></div>
      </div>
    </div>
    <div id="rejection-modal" class="modal-overlay">
      <div class="modal-content">
        <button class="modal-close-btn" onclick="closeModal('rejection-modal')">
          &times;
        </button>
        <h2>Reason for Rejection</h2>
        <p>Please provide a reason for rejecting this item.</p>
        <textarea id="rejection-reason-text"></textarea>
        <div class="modal-actions">
          <button id="rejection-cancel-btn" onclick="closeModal('rejection-modal')">
            Cancel
          </button>
          <button id="rejection-submit-btn">Submit Rejection</button>
        </div>
      </div>
    </div>

    <script>
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrwUdXo0iEj4IMh3OKEjj8o4lVjvUkrq2GG_we3tLJcwGT4LgA2FoHKd6BLZW3Rqxc/exec";

      let loadedData = {};
      let availableColumns = {};
      let currentUser = "";
      const DEFAULT_VISIBLE_COLS = ["uniqueID", "vendor", "invoiceNumber", "finalAmountPayable", "pDFLink", "hODApproval"];

      async function callAppsScript(functionName, params = []) {
        const response = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: {
            "Content-Type": "text/plain;charset=utf-8"
          },
          body: JSON.stringify({
            action: functionName,
            params: params
          }),
        });
        const result = await response.json();
        if (!result.success) throw new Error(result.message);
        return result.data;
      }

      document.addEventListener("DOMContentLoaded", async () => {
        currentUser = localStorage.getItem("approvalName");
        const userType = localStorage.getItem("approvalType");

        if (!currentUser || userType !== "Final") {
          window.location.href = "index.html";
          return;
        }

        document.getElementById("welcome-message").textContent += ` (Welcome, ${currentUser})`;
        document.querySelectorAll(".modal-overlay").forEach((modal) => {
          modal.onclick = (event) => {
            if (event.target === modal) closeModal(modal.id);
          };
        });
        window.addEventListener("click", () => {
          document.querySelectorAll(".column-dropdown").forEach((d) => d.classList.remove("visible"));
        });

        try {
          const [userData, hodData, payData] = await Promise.all([
            callAppsScript("getUserData", [currentUser, "Final"]),
            callAppsScript("getHodPendingData"),
            callAppsScript("getPayData"),
          ]);

          loadedData = {
            pending: userData.pending,
            approved: userData.approved,
            rejected: userData.rejected,
            "hod-pending": hodData,
            "pay": payData
          };
          availableColumns = userData.columnMap;

          initializeColumnSelectors();
          renderTable("pending", loadedData.pending);
          renderTable("approved", loadedData.approved);
          renderTable("rejected", loadedData.rejected);
          renderTable("hod-pending", loadedData["hod-pending"]);
          renderTable("pay", loadedData.pay);

          const urlParams = new URLSearchParams(window.location.search);
          const sectionToShow = urlParams.get("section");
          if (sectionToShow && document.getElementById(sectionToShow + "-section")) {
            showSection(sectionToShow);
          } else {
            showSection("pending");
          }
        } catch (error) {
          alert("Failed to load data: " + error.message);
          document.getElementById("pending-loader").style.display = "none";
          document.getElementById("approved-loader").style.display = "none";
          document.getElementById("rejected-loader").style.display = "none";
          document.getElementById("hod-pending-loader").style.display = "none";
          document.getElementById("pay-loader").style.display = "none";
        }
      });

      function showSection(sectionName) {
        document.querySelectorAll(".content-section").forEach((sec) => sec.classList.remove("visible"));
        document.querySelectorAll(".sidebar-nav button, .sidebar-nav a").forEach((btn) => btn.classList.remove("active"));
        document.getElementById(sectionName + "-section").classList.add("visible");
        const navButton = document.getElementById("nav-" + sectionName);
        if (navButton) navButton.classList.add("active");
        document.getElementById("nav-queues").classList.add("active");
      }

      function logoutUser() {
        localStorage.clear();
        window.location.href = "index.html";
      }

      async function showDetails(uniqueId) {
        const modalBody = document.getElementById("modal-body");
        modalBody.innerHTML = '<div class="loader">Loading...</div>';
        openModal("details-modal");
        try {
          const details = await callAppsScript("getEntryDetails", [uniqueId]);
          if (!details) {
            modalBody.innerHTML = "Error: Entry not found.";
            return;
          }
          let contentHtml = "";
          for (const key in details) {
            if (details[key] !== "") {
              let value = details[key];
              if (typeof value === "string" && value.startsWith("http")) {
                value = `<a href="${value}" target="_blank" class="pdf-link">${value}</a>`;
              }
              contentHtml += `<div class="key">${key}:</div><div class="value">${value}</div>`;
            }
          }
          modalBody.innerHTML = contentHtml;
        } catch (error) {
          modalBody.innerHTML = `Error: ${error.message}`;
        }
      }

      function handleHodPendingAction(uniqueId, isApproved, btnElement, tableType) {
        event.stopPropagation();
        if (isApproved) {
          submitHodAndFinalUpdate(uniqueId, "Approved", btnElement, tableType);
        } else {
          openModal("rejection-modal");
          const reasonText = document.getElementById("rejection-reason-text");
          const submitBtn = document.getElementById("rejection-submit-btn");
          reasonText.value = "";
          submitBtn.onclick = () => {
            const reason = reasonText.value.trim();
            if (!reason) {
              alert("A reason is required to reject an item.");
              return;
            }
            submitHodAndFinalUpdate(uniqueId, `Rejected: ${reason}`, btnElement, tableType);
          };
        }
      }

      async function submitHodAndFinalUpdate(uniqueId, newStatus, btnElement, tableType) {
        closeModal("rejection-modal");
        const actionCell = btnElement.parentElement;
        actionCell.innerHTML = "Submitting...";
        try {
          await callAppsScript("updateHodAndFinalStatus", [uniqueId, newStatus, currentUser]);
          
          const updatedHodData = await callAppsScript("getHodPendingData"); 
          loadedData["hod-pending"] = updatedHodData;
          renderTable("hod-pending", loadedData["hod-pending"]);
          
          const userData = await callAppsScript("getUserData", [currentUser, "Final"]);
          loadedData.pending = userData.pending;
          loadedData.approved = userData.approved;
          loadedData.rejected = userData.rejected;
          renderTable("pending", loadedData.pending);
          renderTable("approved", loadedData.approved);
          renderTable("rejected", loadedData.rejected);

          showSection(tableType);
        } catch (error) {
          alert("Submission failed: " + error.message);
          actionCell.innerHTML = `<button class="approve-btn" onclick="handleHodPendingAction('${uniqueId}', true, this, '${tableType}')">Approve</button><button class="reject-btn" onclick="handleHodPendingAction('${uniqueId}', false, this, '${tableType}')">Reject</button>`;
        }
      }

      function handleApproval(uniqueId, isApproved, btnElement, tableType) {
        event.stopPropagation();
        if (isApproved) {
          submitUpdate(uniqueId, "Approved", btnElement, tableType);
        } else {
          openModal("rejection-modal");
          const reasonText = document.getElementById("rejection-reason-text");
          const submitBtn = document.getElementById("rejection-submit-btn");
          reasonText.value = "";
          submitBtn.onclick = () => {
            const reason = reasonText.value.trim();
            if (!reason) {
              alert("A reason is required to reject an item.");
              return;
            }
            submitUpdate(uniqueId, `Rejected: ${reason}`, btnElement, tableType);
          };
        }
      }

      async function submitUpdate(uniqueId, newStatus, btnElement, tableType) {
        closeModal("rejection-modal");
        const actionCell = btnElement.parentElement;
        actionCell.innerHTML = "Submitting...";
        try {
          await callAppsScript("updateApprovalStatus", [uniqueId, newStatus, "Final", currentUser]);
          
          const userData = await callAppsScript("getUserData", [currentUser, "Final"]);
          loadedData.pending = userData.pending;
          loadedData.approved = userData.approved;
          loadedData.rejected = userData.rejected;

          renderTable("pending", loadedData.pending);
          renderTable("approved", loadedData.approved);
          renderTable("rejected", loadedData.rejected);
          
          showSection(tableType);
        } catch (error) {
          alert("Submission failed: " + error.message);
          actionCell.innerHTML = `<button class="approve-btn" onclick="handleApproval('${uniqueId}', true, this, '${tableType}')">Approve</button><button class="reject-btn" onclick="handleApproval('${uniqueId}', false, this, '${tableType}')">Reject</button>`;
        }
      }

      function renderTable(tableType, data) {
        const table = document.getElementById(`${tableType}-table`);
        const thead = table.querySelector("thead");
        const tbody = table.querySelector("tbody");
        document.getElementById(`${tableType}-loader`).style.display = "none";
        thead.innerHTML = "";
        tbody.innerHTML = "";
        if (!data || data.length === 0) {
          document.getElementById(`no-${tableType}`).style.display = "block";
          table.style.display = "none";
          return;
        }
        table.style.display = "table";
        document.getElementById(`no-${tableType}`).style.display = "none";
        const storageKey = `final-${tableType}-cols`;
        let visibleCols = JSON.parse(localStorage.getItem(storageKey)) || DEFAULT_VISIBLE_COLS;
        const headerRow = document.createElement("tr");
        visibleCols.forEach((key) => {
          if (availableColumns[key]) {
            const th = document.createElement("th");
            th.textContent = availableColumns[key];
            headerRow.appendChild(th);
          }
        });

        if (tableType === "pending" || tableType === "hod-pending") {
          headerRow.insertAdjacentHTML("beforeend", "<th>Action</th>");
        } else if (tableType !== "pay" && !visibleCols.includes("status")) {
          headerRow.insertAdjacentHTML("beforeend", "<th>Status</th>");
        }
        thead.appendChild(headerRow);
        data.forEach((row) => {
          const tr = document.createElement("tr");
          tr.onclick = () => showDetails(row.uniqueID);
          visibleCols.forEach((key) => {
            if (availableColumns[key]) {
              const td = document.createElement("td");
              if (key === "pDFLink" && row[key]) {
                td.innerHTML = `<a href="${row[key]}" target="_blank" class="pdf-link" onclick="event.stopPropagation()">View Bill</a>`;
              } else {
                td.textContent = row[key];
              }
              tr.appendChild(td);
            }
          });
          if (tableType === "pending") {
            tr.insertAdjacentHTML("beforeend", `<td onclick="event.stopPropagation()"><button class="approve-btn" onclick="handleApproval('${row.uniqueID}', true, this, 'pending')">Approve</button><button class="reject-btn" onclick="handleApproval('${row.uniqueID}', false, this, 'pending')">Reject</button></td>`);
          } else if (tableType === "hod-pending") {
            tr.insertAdjacentHTML("beforeend", `<td onclick="event.stopPropagation()"><button class="approve-btn" onclick="handleHodPendingAction('${row.uniqueID}', true, this, 'hod-pending')">Approve</button><button class="reject-btn" onclick="handleHodPendingAction('${row.uniqueId}', false, this, 'hod-pending')">Reject</button></td>`);
          } else if (tableType !== "pay" && !visibleCols.includes("status")) {
            tr.insertAdjacentHTML("beforeend", `<td>${row.status || ""}</td>`);
          }
          tbody.appendChild(tr);
        });
      }

      function initializeColumnSelectors() {
        ["pending", "approved", "rejected", "hod-pending", "pay"].forEach((tableType) => {
          const selectorContainer = document.getElementById(`${tableType}-selector`);
          if (!selectorContainer) return;
          const storageKey = `final-${tableType}-cols`;
          const btn = document.createElement("button");
          btn.className = "column-selector-btn";
          btn.textContent = "Select Columns";
          const dropdown = document.createElement("div");
          dropdown.className = "column-dropdown";
          let visibleCols = JSON.parse(localStorage.getItem(storageKey)) || DEFAULT_VISIBLE_COLS;
          Object.entries(availableColumns).forEach(([key, title]) => {
            if (title.toLowerCase().includes("status") || title.toLowerCase().includes("approval")) return;
            const optionDiv = document.createElement("div");
            optionDiv.innerHTML = `<input type="checkbox" id="${tableType}-${key}" value="${key}" ${visibleCols.includes(key) ? "checked" : ""}/><label for="${tableType}-${key}">${title}</label>`;
            optionDiv.querySelector("input").addEventListener("change", () => {
              const newVisibleCols = Array.from(dropdown.querySelectorAll("input:checked")).map((cb) => cb.value);
              localStorage.setItem(storageKey, JSON.stringify(newVisibleCols));
              renderTable(tableType, loadedData[tableType]);
            });
            dropdown.appendChild(optionDiv);
          });
          selectorContainer.innerHTML = "";
          selectorContainer.appendChild(btn);
          selectorContainer.appendChild(dropdown);
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            dropdown.classList.toggle("visible");
          });
        });
      }
    </script>
  </body>
</html>
