<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>CFO Dashboard</title>
    <!-- Using Chart.js library for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Base Styles (unchanged) --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; color: #333; display: flex; height: 100vh; }
        .sidebar { width: 200px; background-color: #2c3e50; color: white; padding-top: 20px; display: flex; flex-direction: column; flex-shrink: 0; z-index: 10; }
        .main-content { flex-grow: 1; padding: 20px 40px; overflow-y: auto; }
        .sidebar-header { padding: 0 20px 20px 20px; font-size: 1.2em; font-weight: bold; border-bottom: 1px solid #34495e; }
        .sidebar-nav { flex-grow: 1; }
        .sidebar-nav a, .logout-btn { display: block; width: 100%; padding: 15px 20px; background: none; border: none; color: #bdc3c7; text-align: left; font-size: 1em; cursor: pointer; border-bottom: 1px solid #34495e; text-decoration: none; box-sizing: border-box; }
        .sidebar-nav a:hover, .logout-btn:hover { background-color: #34495e; color: #ffffff; }
        .sidebar-nav a.active { background-color: #4267B2; color: #ffffff; font-weight: bold; }
        .logout-btn { border-top: 1px solid #34495e; border-bottom: none; }
        h1, h2 { color: #1c1e21; padding-bottom: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd; }

        /* --- NEW: Enhanced Loader Styles --- */
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f2f5; z-index: 999; display: flex; justify-content: center; align-items: center; }
        .spinner { border: 5px solid rgba(0, 0, 0, 0.1); border-left-color: #4267B2; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-overlay.hidden { display: none; }
        #dashboard-content { opacity: 0; transition: opacity 0.5s ease-in-out; }
        #dashboard-content.visible { opacity: 1; }

        /* --- NEW: Dynamic Dashboard Styles --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card-link { text-decoration: none; color: inherit; }
        .stat-card { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .stat-card .number { font-size: 2.5em; font-weight: bold; color: #4267B2; margin-bottom: 5px; }
        .stat-card .label { font-size: 1em; color: #555; }

        .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .activity-container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .activity-container table { width: 100%; border-collapse: collapse; }
        .activity-container th, .activity-container td { text-align: left; padding: 12px 15px; border-bottom: 1px solid #ddd; }
        .activity-container thead { background-color: #f8f9fa; color: #333; }
        .status-approved { color: #28a745; font-weight: bold; }
        .status-rejected { color: #dc3545; font-weight: bold; }

        @media (max-width: 992px) { .charts-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">CFO Approval</div>
        <div class="sidebar-nav">
            <a id="nav-dashboard" href="cfo_dashboard.html" class="active">Dashboard</a>
            <a id="nav-pending" href="cfo.html">Approval Queues</a>
        </div>
        <button class="logout-btn" onclick="logoutUser()">Logout</button>
    </div>

    <div class="main-content">
        <h1 id="welcome-message">Dashboard</h1>
        
        <!-- NEW Loader -->
        <div id="loader" class="loader-overlay">
            <div class="spinner"></div>
        </div>

        <div id="dashboard-content">
            <!-- NEW: Clickable Stat Cards -->
            <div class="dashboard-grid">
                <a href="cfo.html?section=pending" class="stat-card-link">
                    <div class="stat-card"><div id="my-pending-count" class="number">0</div><div class="label">My Pending</div></div>
                </a>
                <a href="cfo.html?section=approved" class="stat-card-link">
                    <div class="stat-card"><div id="approved-count" class="number">0</div><div class="label">Total Approved</div></div>
                </a>
                <a href="cfo.html?section=rejected" class="stat-card-link">
                    <div class="stat-card"><div id="rejected-count" class="number">0</div><div class="label">Total Rejected</div></div>
                </a>
                <a href="cfo.html?section=accountant-pending" class="stat-card-link">
                    <div class="stat-card"><div id="accountant-pending-count" class="number">0</div><div class="label">Pending from Accountant</div></div>
                </a>
            </div>

            <div class="charts-grid">
                <div class="chart-container"><h2>Approvals Overview</h2><canvas id="overviewChart"></canvas></div>
                <div class="chart-container"><h2>Decision Ratio</h2><canvas id="ratioChart"></canvas></div>
            </div>

            <div class="activity-container">
                <h2>Recent Activity</h2>
                <table id="recent-activity-table">
                    <thead><tr><th>Unique ID</th><th>Vendor</th><th>Amount</th><th>Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrwUdXo0iEj4IMh3OKEjj8o4lVjvUkrq2GG_we3tLJcwGT4LgA2FoHKd6BLZW3Rqxc/exec";

        async function callAppsScript(functionName, params = []) {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: functionName, params: params })
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.message);
            return result.data;
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const currentUser = localStorage.getItem('approvalName');
            const userType = localStorage.getItem('approvalType');

            if (!currentUser || userType !== 'CFO') {
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('welcome-message').textContent += ` (Welcome, ${currentUser})`;

            try {
                const [userData, accountantData] = await Promise.all([
                    callAppsScript('getUserData', [currentUser, 'CFO']),
                    callAppsScript('getAccountantPendingData')
                ]);
                
                populateStats(userData, accountantData);
                renderCharts(userData, accountantData);
                populateRecentActivity(userData);

                // Fade in content and hide loader
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('dashboard-content').classList.add('visible');

            } catch (error) {
                const loader = document.getElementById('loader');
                loader.innerHTML = `<p style="color: #dc3545;">Failed to load dashboard: ${error.message}</p>`;
            }
        });
        
        // NEW: Function to animate numbers counting up
        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        function populateStats(userData, accountantData) {
            animateValue(document.getElementById('my-pending-count'), 0, userData.pending.length, 1000);
            animateValue(document.getElementById('approved-count'), 0, userData.approved.length, 1000);
            animateValue(document.getElementById('rejected-count'), 0, userData.rejected.length, 1000);
            animateValue(document.getElementById('accountant-pending-count'), 0, accountantData.length, 1000);
        }

        function renderCharts(userData, accountantData) {
            const overviewCtx = document.getElementById('overviewChart').getContext('2d');
            new Chart(overviewCtx, {
                type: 'bar',
                data: {
                    labels: ['My Pending', 'Approved', 'Rejected', 'Accountant Pending'],
                    datasets: [{
                        label: 'Number of Items',
                        data: [ userData.pending.length, userData.approved.length, userData.rejected.length, accountantData.length ],
                        backgroundColor: [ 'rgba(255, 159, 64, 0.5)', 'rgba(75, 192, 192, 0.5)', 'rgba(255, 99, 132, 0.5)', 'rgba(54, 162, 235, 0.5)' ],
                        borderColor: [ 'rgba(255, 159, 64, 1)', 'rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)' ],
                        borderWidth: 1
                    }]
                },
                options: { scales: { y: { beginAtZero: true, grace: '10%' } }, plugins: { legend: { display: false } } }
            });

            const ratioCtx = document.getElementById('ratioChart').getContext('2d');
            new Chart(ratioCtx, {
                type: 'pie',
                data: {
                    labels: ['Approved', 'Rejected'],
                    datasets: [{
                        data: [userData.approved.length, userData.rejected.length],
                        backgroundColor: ['rgba(75, 192, 192, 0.8)', 'rgba(255, 99, 132, 0.8)'],
                        hoverOffset: 8
                    }]
                },
                options: { plugins: { legend: { position: 'top' } } }
            });
        }

        function populateRecentActivity(userData) {
            const tbody = document.getElementById('recent-activity-table').querySelector('tbody');
            tbody.innerHTML = '';
            const allHandledItems = [...userData.approved, ...userData.rejected].reverse();
            const recentItems = allHandledItems.slice(0, 5);

            if (recentItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No recent activity found.</td></tr>';
                return;
            }

            recentItems.forEach(item => {
                const statusClass = item.status === 'Approved' ? 'status-approved' : 'status-rejected';
                tbody.innerHTML += `
                    <tr>
                        <td>${item.uniqueID}</td>
                        <td>${item.vendor}</td>
                        <td>${item.finalAmountPayable}</td>
                        <td><span class="${statusClass}">${item.status.split(':')[0]}</span></td>
                    </tr>`;
            });
        }

        function logoutUser() {
            localStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
